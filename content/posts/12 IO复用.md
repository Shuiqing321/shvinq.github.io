---
title: "12 IO复用"
date: "2021-08-20T02:20:04+08:00"
tags:
categories: ["网络编程"]
showToc: true
TocOpen: false
draft: false
hidemeta: false
comments: false
disableHLJS: true
disableShare: false
disableHLJS: false
hideSummary: false
searchHidden: true
ShowReadingTime: false
ShowBreadCrumbs: true
ShowPostNavLinks: true
---

### 1.运用select函数

使用select函数时可以将多个文件描述符集中到一起统一监视，项目如下：

- 是否存在套接字接收数据？
- 无需阻塞传输数据的套接字有哪些？
- 哪些套接字发生了异常？

### 2.select函数调用方法和顺序：

##### **步骤1**

- 设置文件描述符
- 指定监视范围
- 设置超时

##### **步骤2：**

- 调用select函数

**步骤3：**

- 查看调用结果



**设置文件描述符**

利用select函数可以同时监控多个文件描述符，监视文件描述符可以看成监视套接字。首先要将监视的文件描述符集中到一起，集中时也要按照监视项(接收、传输、异常)进行区分，即将监视项分为3类。

使用fd_set数组变量执行此项操作，该数组是存有0和1的位数组。

| fd0  | fd1  | fd2  | fd3  |        |
| ---- | ---- | ---- | ---- | ------ |
| 0    | 1    | 0    | 1    | ...... |

针对fd_set变量的操作是以位为单位进行的，在fd_set变量中注册或更改值由宏完成

- FD_ZERO(fd_set * fdset):	将fd_set变量的所有位初始化为0
- FD_SET(int fd,  fd_set * fdset)；   在参数fdset指向的变量中注册文件描述符fd的信息
- FD_CLR(int fd,  fd_set * fdset)；   从参数fdset指向的变量中清除文件描述符fd的信息
- FD_ISSET(int fd, fd_set * fdset);    若参数fdset指向的变量中包含文件描述符fd的信息。则返回“真”

**设置检查(监视)范围和超时**

```c
#include <sys/select.h>
#include <time.h>
ine select(int maxfd, fd_set*readset, fd_set*writeset, fd_set*exceptset, const struct timeval*timeout);
//成功返回大于0的值，失败返回-1
/*
maxfd: 监视对象文件描述符的数量
readset: 将所有关注“是否存在待读取数据”的文件描述符注册到fd_set型变量，并传递其地址值
writeset: 将所有关注“是否可传输无阻塞数据”的文件描述符注册到fd_set型变量，并传递其地址值
exceptset: 将所有关注“是否发生异常”的文件描述符注册到fd_set型变量，并传递其地址值
timeout: 调用select函数后，为防止陷入无限阻塞的状态，传递超时(time-out)信息
返回值: 发生错误时返回-1，超时返回时返回0。因发生关注事件返回时，返回大于0的值，该值是发生事件的文件描述符数
*/
```

调用select函数前需要决定：

1. 文件描述符的监视(检查)范围
2. 如何设定select函数的超时时间

第一，文件描述符的监视范围通过第一个参数传递监视对象文件描述符的数量决定。因此需要得到注册在fd_set变量中文件描述符数，每次新建文件描述符，其值就会加1，所以只需将最大的文件描述符值加1传递给select函数即可。

第二，timeval结构体定义如下: 

```c
struct timeval
{
    long tv_sec;	//seconds
    long tv_usec;	//microseconds
}
```

原本select函数只有在监视的文件描述符发生变化时才返回，如果未发生变化就进入阻塞状态。指定超时时间就是为了防止阻塞。将该结构体变量指针传入select函数中，即使文件描述符未发生变化，只要过了指定时间，也可以从函数返回。此时select函数是返回0，因此可以通过返回值了解返回原因。如果不想设置超时，传递NULL即可。

**调用select函数后查看结果**

如果返回大于0的整数，说明对应数量的文件描述符发生了变化。文件描述符变化是指监控的文件描述符发生了对应的监控事件。例如通过select的第二个参数传递的集合中存在需要读数据的描述符时，就意味着文件描述符发生变化。